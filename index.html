<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世代的遗志：百年诅咒</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #0c0a09; /* stone-950 */
            color: #d6d3d1; /* stone-300 */
        }
        
        .parchment {
            background-color: #1c1917; /* stone-900 */
            border: 1px solid #44403c; /* stone-700 */
            box-shadow: 0 4px 20px rgba(0,0,0,0.9);
        }

        .parchment-inset {
            background-color: #151413;
            border-inner: 1px solid #000;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.8);
        }

        .btn-action {
            background: linear-gradient(to bottom, #292524, #1c1917);
            border: 1px solid #57534e;
            color: #e7e5e4;
            padding: 8px 16px;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-align: center;
            cursor: pointer;
            text-shadow: 0 1px 2px black;
        }

        .btn-action:hover {
            background: linear-gradient(to bottom, #44403c, #292524);
            border-color: #a8a29e;
            color: #fff;
        }

        .log-entry {
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid #292524;
            animation: fadeIn 0.5s ease;
        }

        .text-highlight { color: #fca5a5; } /* red-300 */
        .text-magic { color: #93c5fd; } /* blue-300 */
        .text-gold { color: #fde047; } /* yellow-300 */

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(3px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0c0a09; }
        ::-webkit-scrollbar-thumb { background: #44403c; }
        
        /* Subtle Ken Burns effect for image */
        .scene-pan {
            animation: panImage 30s infinite alternate linear;
        }
        @keyframes panImage {
            from { transform: scale(1.0); }
            to { transform: scale(1.1); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">

    <!-- Header (Compact) -->
    <header class="w-full max-w-5xl mb-2 flex justify-between items-end border-b border-stone-800 pb-2">
        <div>
            <h1 class="text-2xl font-bold text-stone-200 tracking-wider" style="text-shadow: 0 2px 4px black;">世代的遗志：百年诅咒</h1>
            <p class="text-xs text-stone-600 italic">Legacy of Generations: The Century Curse</p>
        </div>
        <div class="text-right text-xs text-stone-500">
            <span id="gen-count-header">序章</span> | <span id="depth-count-header">入口</span>
        </div>
    </header>

    <!-- Main Game Container -->
    <div class="w-full max-w-5xl flex flex-col gap-3">
        
        <!-- Top: Massive Scene Display -->
        <div class="parchment p-1 w-full h-[50vh] min-h-[300px] max-h-[500px] rounded overflow-hidden relative group">
            <div id="loading-overlay" class="absolute inset-0 bg-black bg-opacity-80 flex items-center justify-center z-20 hidden backdrop-blur-sm">
                <div class="text-center">
                    <div class="text-stone-500 text-sm mb-2">命运编织中...</div>
                    <div class="w-16 h-1 bg-stone-800 mx-auto overflow-hidden"><div class="h-full bg-stone-500 animate-pulse"></div></div>
                </div>
            </div>
            <!-- Overlay Gradient for better text visibility if needed, or just atmosphere -->
            <div class="absolute inset-0 bg-gradient-to-t from-stone-950 via-transparent to-transparent opacity-60 z-10 pointer-events-none"></div>
            
            <img id="scene-image" src="https://image.pollinations.ai/prompt/massive%20gothic%20castle%20fortress%20looming%20in%20dark%20foggy%20mountains%20epic%20scale%20dramatic%20moonlight%20cinematic%20fantasy%20landscape?width=1280&height=720&nologo=true" 
                 alt="Scene" class="w-full h-full object-cover scene-pan opacity-90">
        </div>

        <!-- Bottom: Info & Controls Grid -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 h-[280px]">
            
            <!-- Bottom Left: Compact Stats (3 cols) -->
            <div class="md:col-span-3 parchment p-3 rounded flex flex-col justify-between">
                <div>
                    <h3 class="text-sm font-bold text-stone-400 border-b border-stone-800 pb-1 mb-2 uppercase tracking-widest">当前家主</h3>
                    <div id="character-info" class="space-y-1 text-xs text-stone-400">
                        <div class="flex justify-between"><span class="text-stone-600">姓名</span> <span id="char-name" class="text-stone-300">-</span></div>
                        <div class="flex justify-between"><span class="text-stone-600">职业</span> <span id="char-class" class="text-stone-300">-</span></div>
                        
                        <div class="mt-3">
                            <div class="flex justify-between mb-1 text-[10px] uppercase text-stone-600"><span>Vitality</span> <span id="hp-text">0/0</span></div>
                            <div class="w-full bg-stone-900 h-1.5 rounded-full overflow-hidden border border-stone-800">
                                <div id="hp-bar" class="bg-red-900 h-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-1 mt-2 text-center">
                    <div class="bg-stone-900/50 p-1 rounded border border-stone-800">
                        <div class="text-[10px] text-stone-600 uppercase">STR</div>
                        <div id="stat-str" class="font-bold text-stone-300 text-sm">0</div>
                    </div>
                    <div class="bg-stone-900/50 p-1 rounded border border-stone-800">
                        <div class="text-[10px] text-stone-600 uppercase">INT</div>
                        <div id="stat-int" class="font-bold text-stone-300 text-sm">0</div>
                    </div>
                    <div class="bg-stone-900/50 p-1 rounded border border-stone-800">
                        <div class="text-[10px] text-stone-600 uppercase">AGI</div>
                        <div id="stat-agi" class="font-bold text-stone-300 text-sm">0</div>
                    </div>
                </div>
            </div>

            <!-- Bottom Right: Log & Actions (9 cols) -->
            <div class="md:col-span-9 parchment p-0 rounded flex flex-col overflow-hidden relative">
                <!-- Log Area -->
                <div id="game-log" class="flex-1 overflow-y-auto p-3 font-light text-stone-400 text-xs leading-relaxed parchment-inset m-1 rounded mb-0">
                    <div class="log-entry italic text-stone-600">
                        史官：编年史已展开。画面已重构，以展现更宏大的命运视角。
                    </div>
                </div>

                <!-- Action Area -->
                <div id="action-area" class="p-2 border-t border-stone-800 bg-[#1c1917]">
                    <div id="controls" class="grid grid-cols-2 gap-2">
                        <button onclick="game.init()" class="btn-action col-span-2 font-bold tracking-widest text-stone-300">开启新的篇章</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Game Data & Config ---
        const CLASSES = {
            guardian: { 
                name: "守护者", 
                hp: 120, 
                str: 8, int: 2, agi: 3, 
                desc: "身披重甲，坚信意志如钢。",
                skill: "无畏冲锋",
                prompt: "lone tiny knight figure standing before a massive colossal ruined dungeon entrance towering ancient architecture dark gritty fantasy wide angle extreme long shot"
            },
            mystic: { 
                name: "秘法师", 
                hp: 80, 
                str: 2, int: 10, agi: 4, 
                desc: "掌握禁忌知识，操控奥术。",
                skill: "奥术震荡",
                prompt: "tiny wizard figure channeling arcane energy atop a high tower overlooking a vast cursed landscape swirling magical clouds epic scale wide view"
            },
            ranger: { 
                name: "游侠", 
                hp: 90, 
                str: 4, int: 3, agi: 9, 
                desc: "阴影中的行者。",
                skill: "暗影突袭",
                prompt: "tiny hooded rogue silhouette perched on a high gargoyle overlooking a sprawling dark gothic city below foggy night vast view wide angle"
            }
        };

        const ENEMIES = [
            { name: "腐朽骷髅", hp: 30, atk: 5, exp: 10, prompt: "skeleton warrior army formation in a vast dark ancient crypt hall cinematic lighting wide shot" },
            { name: "深渊史莱姆", hp: 45, atk: 4, exp: 15, prompt: "massive green slime monster occupying a whole deep underground toxic cavern glowing goo lake" },
            { name: "家族怨灵", hp: 25, atk: 8, exp: 20, prompt: "hundreds of translucent ghostly spirits floating in a long haunted castle corridor endless hallway" },
            { name: "地穴魔蛛", hp: 60, atk: 7, exp: 30, prompt: "colossal giant spider glowing eyes on a massive web inside a gigantic dark cave bottomless pit" }
        ];

        // --- Game Engine ---
        const game = {
            state: {
                generation: 0,
                depth: 1,
                hero: null,
                enemy: null,
                legacyBonus: { str: 0, int: 0, agi: 0 },
                history: []
            },

            // Utility: UI Updates
            ui: {
                log: (text, type = 'normal') => {
                    const logEl = document.getElementById('game-log');
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    if (type === 'combat') div.className += ' text-highlight';
                    if (type === 'gain') div.className += ' text-gold';
                    if (type === 'magic') div.className += ' text-magic';
                    
                    // Timestamp for log
                    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    div.innerHTML = `<span class="text-[9px] text-stone-700 mr-1">[${time}]</span> ${text}`;
                    
                    logEl.appendChild(div);
                    logEl.scrollTop = logEl.scrollHeight;
                },
                
                updateStats: () => {
                    if (!game.state.hero) return;
                    
                    // Update Header
                    document.getElementById('gen-count-header').innerText = `第 ${game.state.generation} 代`;
                    document.getElementById('depth-count-header').innerText = `地下 ${game.state.depth} 层`;

                    // Update Card
                    document.getElementById('char-name').innerText = game.state.hero.name;
                    document.getElementById('char-class').innerText = game.state.hero.className;
                    document.getElementById('hp-text').innerText = `${game.state.hero.currentHp}/${game.state.hero.maxHp}`;
                    
                    const pct = (game.state.hero.currentHp / game.state.hero.maxHp) * 100;
                    document.getElementById('hp-bar').style.width = `${Math.max(0, pct)}%`;

                    document.getElementById('stat-str').innerText = game.state.hero.str;
                    document.getElementById('stat-int').innerText = game.state.hero.int;
                    document.getElementById('stat-agi').innerText = game.state.hero.agi;
                },

                setImage: (promptKey) => {
                    const overlay = document.getElementById('loading-overlay');
                    const img = document.getElementById('scene-image');
                    overlay.classList.remove('hidden');
                    
                    const seed = Math.floor(Math.random() * 1000);
                    // Optimized prompt for wide cinematic shots (16:9 ratio in URL)
                    const encodedPrompt = encodeURIComponent(`gothic dark fantasy art style, ${promptKey}, cinematic lighting, atmospheric, 8k resolution, wide angle, epic scale --seed ${seed}`);
                    
                    const newSrc = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1280&height=720&nologo=true`;
                    
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        img.src = newSrc;
                        overlay.classList.add('hidden');
                    };
                    tempImg.src = newSrc;
                },

                setControls: (buttons) => {
                    const area = document.getElementById('controls');
                    area.innerHTML = '';
                    buttons.forEach(btn => {
                        const b = document.createElement('button');
                        b.className = 'btn-action';
                        b.innerText = btn.text;
                        b.onclick = btn.action;
                        if (btn.full) b.className += ' col-span-2';
                        area.appendChild(b);
                    });
                }
            },

            // Game Logic
            init: () => {
                game.state.generation = 1;
                game.state.depth = 1;
                game.state.legacyBonus = { str: 0, int: 0, agi: 0 };
                document.getElementById('game-log').innerHTML = ''; 
                game.ui.log("史官：一切的开始。德·莱恩家族的诅咒已苏醒。");
                game.creationPhase();
            },

            creationPhase: () => {
                // Wide angle hall
                game.ui.setImage("great ancestral hall of a fallen castle dusty banners gigantic stone statues of knights grand scale mysterious light rays wide shot");
                game.ui.log(`=== 第 ${game.state.generation} 代继承人 ===`);
                game.ui.log("年轻的继承者站在石冢前。请选择你的命运：");
                
                const controls = [
                    { text: "守护者 [生存]", action: () => game.confirmClass('guardian') },
                    { text: "秘法师 [魔法]", action: () => game.confirmClass('mystic') },
                    { text: "游侠 [暴击]", full: true, action: () => game.confirmClass('ranger') }
                ];
                game.ui.setControls(controls);
            },

            confirmClass: (classKey) => {
                const c = CLASSES[classKey];
                const str = c.str + game.state.legacyBonus.str;
                const int = c.int + game.state.legacyBonus.int;
                const agi = c.agi + game.state.legacyBonus.agi;

                game.state.hero = {
                    name: `De Ryan ${game.state.generation}世`,
                    className: c.name,
                    key: classKey,
                    maxHp: c.hp + (game.state.generation * 10),
                    currentHp: c.hp + (game.state.generation * 10),
                    str: str,
                    int: int,
                    agi: agi,
                    skillName: c.skill,
                    basePrompt: c.prompt
                };

                game.ui.updateStats();
                game.ui.log(`<b>${game.state.hero.name}</b> 继承了家主之位。`);
                game.ui.setImage(game.state.hero.basePrompt);
                
                setTimeout(() => game.explorationPhase(), 1000);
            },

            explorationPhase: () => {
                if (game.state.hero.currentHp <= 0) {
                    game.deathPhase();
                    return;
                }

                game.ui.setControls([
                    { text: "深入黑暗 (探索)", full: true, action: () => game.encounter() }
                ]);
                game.ui.log(`地牢深度：${game.state.depth}。周围一片死寂，唯有火把噼啪作响。`);
            },

            encounter: () => {
                game.state.depth++;
                const rand = Math.random();
                
                if (rand < 0.3) {
                    game.eventEncounter();
                } else {
                    game.combatStart();
                }
            },

            eventEncounter: () => {
                const events = [
                    { 
                        text: "发现了一座古老的祭坛，供奉着鲜红的药剂。", 
                        choice: "饮用药水", 
                        effect: () => {
                            const heal = 20;
                            game.state.hero.currentHp = Math.min(game.state.hero.currentHp + heal, game.state.hero.maxHp);
                            game.ui.log(`生命值恢复了 ${heal} 点。`, 'gain');
                            game.ui.updateStats();
                        },
                        img: "ancient glowing altar inside a massive underground cathedral cavern stalactites dark fantasy environment wide shot"
                    },
                    { 
                        text: "先祖的遗骸握着磨刀石，似乎在等待着后人。", 
                        choice: "磨砺武器", 
                        effect: () => {
                            game.state.hero.str += 1;
                            game.ui.log(`武器变得锋利，力量 +1。`, 'gain');
                            game.ui.updateStats();
                        },
                        img: "skeletal remains of a giant warrior slumped against a massive runic pillar in a deep dungeon chasm wide shot"
                    }
                ];
                
                const ev = events[Math.floor(Math.random() * events.length)];
                game.ui.setImage(ev.img);
                game.ui.log(ev.text);
                
                game.ui.setControls([
                    { text: ev.choice, action: () => {
                        ev.effect();
                        setTimeout(() => {
                            game.ui.setImage(game.state.hero.basePrompt);
                            game.explorationPhase();
                        }, 1000);
                    }},
                    { text: "离开", action: () => {
                        game.ui.log("你继续前行。");
                        game.explorationPhase();
                    }}
                ]);
            },

            combatStart: () => {
                const enemyTemplate = ENEMIES[Math.floor(Math.random() * ENEMIES.length)];
                const scaling = 1 + (game.state.depth * 0.1);
                
                game.state.enemy = {
                    ...enemyTemplate,
                    maxHp: Math.floor(enemyTemplate.hp * scaling),
                    currentHp: Math.floor(enemyTemplate.hp * scaling),
                    atk: Math.floor(enemyTemplate.atk * scaling)
                };

                game.ui.setImage(game.state.enemy.prompt);
                game.ui.log(`遭遇敌人：<b>${game.state.enemy.name}</b> (HP: ${game.state.enemy.maxHp})！`, 'combat');
                
                game.combatRound();
            },

            combatRound: () => {
                game.ui.setControls([
                    { text: "攻击", action: () => game.playerAttack('attack') },
                    { text: `技能: ${game.state.hero.skillName}`, action: () => game.playerAttack('skill') }
                ]);
            },

            playerAttack: (type) => {
                const hero = game.state.hero;
                const enemy = game.state.enemy;
                let damage = 0;
                let logMsg = "";

                if (type === 'attack') {
                    damage = Math.floor(hero.str * 1.5 + Math.random() * 5);
                    logMsg = `对 ${enemy.name} 造成 ${damage} 伤害。`;
                } else if (type === 'skill') {
                    if (hero.key === 'guardian') {
                        damage = hero.str * 1.2;
                        hero.currentHp += 10;
                        logMsg = `【无畏冲锋】造成 ${damage.toFixed(0)} 伤害并恢复少量护盾。`;
                    } else if (hero.key === 'mystic') {
                        damage = hero.int * 2.5;
                        logMsg = `【奥术震荡】造成 ${damage.toFixed(0)} 魔法伤害！`;
                    } else if (hero.key === 'ranger') {
                        const crit = Math.random() > 0.4 ? 2.5 : 1;
                        damage = hero.agi * 1.5 * crit;
                        logMsg = crit > 1 
                            ? `【暗影突袭】暴击！造成 ${damage.toFixed(0)} 伤害！`
                            : `【暗影突袭】造成 ${damage.toFixed(0)} 伤害。`;
                    }
                }

                damage = Math.floor(damage);
                enemy.currentHp -= damage;
                game.ui.log(logMsg, 'combat');

                if (enemy.currentHp <= 0) {
                    game.combatWin();
                } else {
                    setTimeout(() => game.enemyTurn(), 800);
                }
            },

            enemyTurn: () => {
                const hero = game.state.hero;
                const enemy = game.state.enemy;
                
                const dodgeChance = hero.agi * 0.02;
                if (Math.random() < dodgeChance) {
                    game.ui.log(`闪避了 ${enemy.name} 的攻击！`, 'magic');
                } else {
                    const dmg = Math.floor(enemy.atk * (1 + Math.random() * 0.5));
                    hero.currentHp -= dmg;
                    game.ui.log(`${enemy.name} 造成了 ${dmg} 伤害。`, 'highlight');
                    game.ui.updateStats();
                }

                if (hero.currentHp <= 0) {
                    setTimeout(() => game.deathPhase(), 1000);
                } else {
                    game.combatRound();
                }
            },

            combatWin: () => {
                game.ui.log(`击败了 ${game.state.enemy.name}！`, 'gain');
                const growth = Math.random();
                if (growth < 0.33) {
                    game.state.hero.str++;
                    game.ui.log("力量提升。", 'gain');
                } else if (growth < 0.66) {
                    game.state.hero.int++;
                    game.ui.log("魔力提升。", 'gain');
                } else {
                    game.state.hero.agi++;
                    game.ui.log("身法提升。", 'gain');
                }
                
                game.ui.updateStats();
                game.state.enemy = null;
                
                game.ui.setControls([
                    { text: "继续前进", full: true, action: () => {
                        game.ui.setImage(game.state.hero.basePrompt);
                        game.explorationPhase();
                    }}
                ]);
            },

            deathPhase: () => {
                game.ui.setImage("endless ancient cemetery filled with crumbling mausoleums under a stormy sky melancholic epic gothic landscape wide shot");
                game.ui.log(`<b>${game.state.hero.name}</b> 陨落。`, 'highlight');
                game.ui.log(`先祖的记忆已铭刻入血脉。`);
                
                game.state.generation++;
                game.state.legacyBonus.str += Math.floor(game.state.hero.str * 0.2);
                game.state.legacyBonus.int += Math.floor(game.state.hero.int * 0.2);
                game.state.legacyBonus.agi += Math.floor(game.state.hero.agi * 0.2);

                game.ui.setControls([
                    { text: `开启第 ${game.state.generation} 代 (继承属性)`, full: true, action: () => game.creationPhase() }
                ]);
            }
        };

        // Start
        game.ui.setControls([
            { text: "翻开编年史", full: true, action: game.init }
        ]);

    </script>
</body>
</html>
